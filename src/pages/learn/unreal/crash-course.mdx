import Image from 'next/image';
import imgCreateThirdPerson from './images/create-third-person-cpp.png';

# ⏱️ Crash Course

Unreal Engine provides great multiplayer capabilities out of the box. We'll use Unreal's built-in networking to build and deploy a server-authoritative multiplayer game on top of Rivet.

<Accordion title='How does Rivet compare to Epic Online Services and Steam Sockets?'>
    Rivet is intended to help run authoritative multiplayer servers. We do not support peer-to-peer networking yet.

    Read more about [authoritative vs peer-to-peer networking](/docs/general/concepts/authoritative-vs-p2p).

    If you want high-performance networking, mobile games, large lobbies, or to prevent cheating, peer-to-peer networking is not a good choice.
</Accordion>

## Helpful links

- Container images in Unreal https://docs.unrealengine.com/5.2/en-US/quick-start-guide-for-using-container-images-in-unreal-engine/
- Unreal Containers dedicated servers https://unrealcontainers.com/docs/use-cases/dedicated-servers

## Prerequisites

- [Docker](https://www.docker.com/products/docker-desktop/)
- [Unreal Engine 5](https://www.unrealengine.com/en-US/download)
	- This guide was written using Unreal Engine 5.2.1.
	- This process is similar if using Unreal Engine 4. If you're using a different version of Unreal Engine and need help, don't hesitate to [reach out](https://discord.gg/BG2vqsJczH).
- [Unreal Engine 5 GitHub access](https://www.unrealengine.com/en-US/ue-on-github)
- About 60 GB of free space (for Unreal Engine Linux build)

---

## Step X: Setup Unreal Engine project

We'll use the third-person template from Unreal Engine. All the components come with networking out of the box. These steps also apply to any other Unreal Engine games.

<Warning>
  If you're following this guide on an existing project, ensure that your project is version controlled before making any changes.
</Warning>

### Create project template (or bring your project)

1. Create a third-person template with the C++ version. We'll create a guide for using Blueprints instead of C++ soon.
2. Set _Quality Preset_, _Starter Content_, and _Raytracing_ to your preferences.
3. Click _Create_.

<Image src={imgCreateThirdPerson} alt='Third person create dialog' />

### Add server target

TODO

### Set up play configuration for testing multiplayer

We will test the networking locally before deploying it.

1. Press the three dots next to the play button and click _Advanced Settings_ to open the _Play In_ settings.
![Play in](/images/unreal-play-settings.png)

2. Scroll down to _Multiplayer Options_. Update the following settings:
	- **Play Net Mode**: Play Standalone
	- **Run Under One Process**: False
![Multiplayer options settings](/images/unreal-multiplayer-options-settings.png)

3. Update the number of players to at least 2.
![Change number of players](/images/unreal-number-of-players.png)

3. Press the green play button or press _Alt + P_.

4. Validate that you can run around and see your movement synchronized between windows.

<Tip>
	See more ways of testing your game [here](/learn/unreal/concepts/test-methods).
</Tip>

---

## Step X: Setup Rivet project

### Install Rivet CLI

[Installation instructions](https://github.com/rivet-gg/cli)

### Initiate project

Run the following in your project's directory:

```bash
rivet init --recommend --matchmaker --matchmaker-port 7777 --matchmaker-dockerfile 'Dockerfile'
```

Don't enable the CDN for this guide. Don't write the token to .env.

Save the development token that's provided to you. You'll use this in a few steps.

### Update _rivet.version.toml_

Update your _rivet.version.toml_ file to look like this:

```toml rivet.version.toml
[matchmaker]
	max_players = 32

[matchmaker.regions]
	lnd-atl = {}
	lnd-fra = {}

[matchmaker.docker]
	dockerfile = "Dockerfile"

	[matchmaker.docker.ports]
		default = { port = 7777, protocol = "udp" }

[matchmaker.game_modes]
	default = {}
```

---

## Step X: Authenticate with GitHub Container Registry

We must authenticate with the GitHub Container Registry to pull the Unreal Engine Docker image. This contains the source code for Unreal Engine for Linux, enabling us to build the dedicated server.

Follow [these](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry#authenticating-with-a-personal-access-token-classic) instructions.

Once complete, run:

```bash
docker pull ghcr.io/epicgames/unreal-engine:dev-5.2.1
```

Replace `5.2.1` with the version of Unreal Engine you're using.

This will take some time to download.

<AccordionGroup>
	<Accordion title='Why does this take so long to download?'>
		This step downloads a copy of Unreal Engine for Linux and its source code. You'll only have to do this once.
	</Accordion>
	<Accordion title='What if I want to build Unreal Engine from source?'>
		It's also possible to build your dedicated server by [building Unreal Engine from source](https://docs.unrealengine.com/5.0/en-US/building-unreal-engine-from-source/). This requires many more prerequisites with a complicated & error prone setup process, so we use Epic's Docker image instead.

		However, this may be required if using a fork of Unreal Engine. Please [reach out](https://discord.com/invite/BG2vqsJczH) if you need help making this work with Rivet.
	</Accordion>
</AccordionGroup>

---

## Step X: Integrate with Rivet

### Update game mode

TODO

### Add development token to config

Copy the development token generated from the Rivet CLI.

Add the following to the end of _Config/DefaultGame.ini_:

```ini Config/DefaultGame.ini
[/Script/MyProject.RivetClient]
DefaultToken=YOUR_TOKEN_HERE
```

Replace `YOUR_TOKEN_HERE` with your development token.

Replace this with a [public namespace token](/general/concepts/handling-game-tokens#public-namespace-tokens) in production.

<Tip>
	If you need to generate a new development token or update the Rivet configuration, run:

	```bash
	rivet dev create-dev-token
	```
</Tip>

### Test the game

1. Open the _Entry_ world.
2. Press _Play_.
3. Click the _Connect_ button you created to call the Rivet API and connect to your local server.

If you run into issues, check the log for warnings and errors.

This is using the Rivet development token to mock production APIs. This lets you test with production APIs while still using your local machine.

---

## Step X: Deploy to Rivet

### Write server Dockerfile

TODO

### Deploy to Rivet

In the root of the project, run the following command:

```bash
rivet deploy -n prod
```

This will deploy your project to your game's production namespace.

### Test with remote game server locally

Now that your game server is running on Rivet, you can test using a production namespace token.

1. Create a new namespace token as described [here](/general/concepts/handling-game-tokens#public-namespace-tokens).
2. Update `DefaultToken` in _Config/DefaultGame.ini_ to match this token.
3. Play the project and click your _Connect_ button. Check that you are able to see the other player run around.

Your game is now up and running on Rivet!

### Build & distribute client

You can build & distribute the game client as you like. Rivet provides a [CDN](/cdn/introduction) to make this easy.

<Warning>
	Make sure you set the `DefaultToken` to a [public namespace token](/general/concepts/handling-game-tokens#public-namespace-tokens) when distributing builds. Otherwise, it will try to connect to the localhost instead of the production game server.
</Warning>